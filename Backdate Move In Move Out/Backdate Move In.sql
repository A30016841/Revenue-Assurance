WITH BASE AS 

( 

select *, 

??????????? case when daysdiff between 0 and 30 then '0-30' 

????????????????? when daysdiff between 31 and 60 then '31-60' 

????????????????? when daysdiff between 61 and 90 then '61-90' 

????????????????? when daysdiff between 91 and 120 then '91-120' 

????????????????? when daysdiff between 121 and 150 then '121-150' 

????????????????? when daysdiff between 151 and 180 then '151-180' 

????????????????? when daysdiff between 181 and 210 then '181-210' 

????????????????? when daysdiff between 211 and 240 then '211-240' 

????????????????? when daysdiff between 241 and 270 then '241-270' 

????????????????? else '270+' end as age_bucket 

from 

( 

select distinct a.contract as contract1, 

??????????????????????? a.created_date, 

??????????????????????? a.proposed_date, 

??????????????????????? DAYS_BETWEEN (TO_DATE (proposed_date, 'YYYY-MM-DD'), TO_DATE((TO_VARCHAR(TO_DATE(a.created_date, 'YYYYMMDD'))), 'YYYY-MM-DD')) as daysdiff, 

??????????????????????? a.process, 

??????????????????????? d.bptype, 

??????????????????????? c.contract, 

??????????????????????? c.moveindate, 

??????????????????????? d.moveoutdate, 

??????????????????????? c.installation, 

??????????????????????? d.contractcreated, 

??????????????????????? d.contract as OLD_CONTRACT, 

??????????????????????? --f.writeoffamountincgst, 

??????????????????????? --d.moveoutdate, 

????????????????? ??? ROW_NUMBER() OVER (PARTITION BY a.contract ORDER BY d.contractcreated desc) AS RN 

??????????????????????? --b.vertrag, 

??????????????????????? --b.begabrpe, 

??????????????????????? --b.endabrpe 

 

from  

( 

(select contract,created_date,cast(proposed_date as date) as proposed_date,process 

from "COMMERCIAL"."ZCMKTT354"  

where process = 'BDMI'  

and created_date between '20190701' and '20200630') a?????  

 

/** join  

(select vertrag,begabrpe,endabrpe from commercial.erch  

join commercial.erchc on erch.belnr = erchc.belnr --and erch.vertrag = '9051461383' 

where simulation = '') b 

on a.contract = b.vertrag **/ 

 

--get installation 

left join "SP_CUSTOMER"."CIA_TheTruthAboutCustomer" c 

on a.contract = c.contract  

 

--get old contract 

left join "SP_CUSTOMER"."CIA_TheTruthAboutCustomer" d 

on c.installation = d.installation 

and d.contractcreated < created_date 

and d.contract <> a.contract 

/** --get movein date 

left join "SP_CUSTOMER"."CIA_TheTruthAboutCustomer" e 

on a.contract = e.contract **/ 

 

/** left join "SP_COMMERCIAL"."CIA_THETRUTHABOUTWRITEOFF" f 

on d.contract = f.contract 

AND WRITEOFFDATE >= '20190101'**/ 

 

/** 

left join  

(SELECT? DISTINCT CONTRACT, POSTINGDATE, INVOICEAMOUNT 

from "SP_COMMERCIAL"."CIA_TheTruthAboutBilling" 

WHERE MAINTRANSACTION = 'Z200' 

) c 

on a.contract = c.contract 

**/ 

--and postingdate between created_date and add_days(created_date,5) 

 

) 

--where b.begabrpe < a.proposed_date --and b.endabrpe <= a.created_date 

--and c.status = 'ACTIVE' 

--and c.contract is not null 

) 

where RN = 1 

and moveindate <> '00000000' 

and bptype in ('UEC','DearCustomer') 

 

--and installation = '9407474868' 

) 

 

/** ,TAD as 

( 

select * from "SP_COMMERCIAL"."CIA_TheTruthAboutDebt" tad 

)**/ 

 

select * -- count(*), sum(writeoffamountincgst) 

from  

( 

SELECT? base.*, 

??????????? f.writeoffamountincgst, 

??????????? f.writeoffdate, 

??????????? --tad.totaloverdue, 

??????????? f.contract, 

??????????? --case when proposed_date = moveindate then 1 else 0 end as sameflag, 

??????????? ROW_NUMBER() OVER (PARTITION BY base.contract1 ORDER BY f.writeoffdate) AS Rownumber 

FROM BASE 

left join "SP_COMMERCIAL"."CIA_THETRUTHABOUTWRITEOFF" f 

on BASE.OLD_CONTRACT = f.contract 

AND WRITEOFFDATE >= MOVEINDATE 

 

--left join tad 

--on base.old_contract = tad.contract 

 

) 

where Rownumber = 1 

--and sameflag = 0 

and writeoffamountincgst <> 0 
