--- GETS MU64 FROM 25/10/2019 ONWARDS---

DROP TABLE SP_COMMERCIAL.MU64OCT;

CREATE TABLE SP_COMMERCIAL.MU64OCT AS
(SELECT *
FROM "COMMERCIAL"."EMMA_CASE" AS A
WHERE A.CCAT = 'MU64'
AND A.CREATED_DATE >= '20191025') ;

--SELECT DISTINCT BILLS RELATED TO MU64 CASES--

DROP TABLE SP_COMMERCIAL.MU64BILLS;

CREATE TABLE SP_COMMERCIAL.MU64BILLS AS
(
SELECT DISTINCT BILL1.* , BILL1C.ZZ_CURR_CHGS 
FROM SP_COMMERCIAL.MU64OCT AS MU

JOIN "COMMERCIAL"."EUIINSTLN" AS INST
ON MU.MAINOBJKEY = INST.INT_UI

JOIN "COMMERCIAL"."EVER" AS CONT
ON INST.ANLAGE = CONT.ANLAGE

JOIN "COMMERCIAL"."HNODS_ST_BILL_ALL_BILLS" AS BILLA
ON INST.ANLAGE = BILLA.INSTALLATION_NUMBER
AND BILLA.BILL_DOC_CREATION_DATE >= MU.CREATED_DATE
AND BILLA.IS_REBILL = 'Y'
AND BILLA.OUTSORT_REASON_CODE = ''

JOIN "COMMERCIAL"."HNODS_ST_BILL_ALL_BILLS" AS BILL1
ON BILL1.INSTALLATION_NUMBER = BILLA.INSTALLATION_NUMBER
AND BIll1.START_BILLING_PERIOD = BILLA.START_BILLING_PERIOD 
AND BIll1.END_BILLING_PERIOD = BILLA.END_BILLING_PERIOD 
AND BIll1.METER_READ_QUALITY = BILLA.METER_READ_QUALITY
AND BILL1.OUTSORT_REASON_CODE = ''

JOIN "COMMERCIAL"."ERCHC" AS BILL1A
ON BILL1.BILL_DOC_NUMBER = BILL1A.BELNR

JOIN "COMMERCIAL"."ERDK" AS BILL1C
ON BILL1A.OPBEL = BILL1C.OPBEL 
);

-- PARTITION RESULTS TO HAVE ROW NUMBERS AGAINST BILL RECORDS

DROP TABLE SP_COMMERCIAL.MU64BILLSROW;

CREATE TABLE SP_COMMERCIAL.MU64BILLSROW AS (

SELECT *,
ROW_NUMBER() OVER (PARTITION BY
	BUSINESS_PARTNER_NUMBER,
	CONTRACT_ACCOUNT_NUMBER,
	CONTRACT_NUMBER,
	INSTALLATION_NUMBER,
	START_BILLING_PERIOD,
	END_BILLING_PERIOD
	ORDER BY PRINT_DATE DESC) AS RN
FROM SP_COMMERCIAL.MU64BILLS
);

-- GET MOST RECENT COPY OF BILL

DROP TABLE SP_COMMERCIAL.MU64FIRSTBILL;
CREATE TABLE SP_COMMERCIAL.MU64FIRSTBILL AS
(
SELECT *
FROM SP_COMMERCIAL.MU64BILLSROW
WHERE RN = '1'
);

-- GET SECOND MOST RECENT COPY OF BILL


DROP TABLE SP_COMMERCIAL.MU64SECONDBILL;
CREATE TABLE SP_COMMERCIAL.MU64SECONDBILL AS
(
SELECT *
FROM SP_COMMERCIAL.MU64BILLSROW
WHERE RN = '2'
);

-- COMPARE TWO COPIES OF BILLS

SELECT DISTINCT A.CONTRACT_NUMBER
FROM SP_COMMERCIAL.MU64FIRSTBILL AS A

JOIN SP_COMMERCIAL.MU64SECONDBILL AS B
ON A.INSTALLATION_NUMBER = B.INSTALLATION_NUMBER
AND A.START_BILLING_PERIOD = B.START_BILLING_PERIOD 
AND A.END_BILLING_PERIOD = B.END_BILLING_PERIOD 
AND A.METER_READ_QUALITY = B.METER_READ_QUALITY
AND A.ZZ_CURR_CHGS = B.ZZ_CURR_CHGS
